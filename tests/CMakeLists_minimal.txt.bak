cmake_minimum_required(VERSION 3.23)

project(ASFWPacketTests LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

set(ASFW_TESTS_DIR "${CMAKE_CURRENT_LIST_DIR}")
set(ASFW_ROOT_DIR "${ASFW_TESTS_DIR}/..")
set(ASFW_DRIVER_DIR "${ASFW_ROOT_DIR}/ASFWDriver")

enable_testing()

find_package(GTest CONFIG QUIET)

if (NOT GTest_FOUND)
  include(FetchContent)
  set(FETCHCONTENT_UPDATES_DISCONNECTED ON)
  FetchContent_Declare(
    googletest
    GIT_REPOSITORY https://github.com/google/googletest.git
    GIT_TAG v1.15.0
  )
  FetchContent_MakeAvailable(googletest)
endif()

# Minimal library for packet serdes only
add_library(asfw_packet_serdes STATIC
    "${ASFW_DRIVER_DIR}/Async/Tx/PacketBuilder.cpp"
    "${ASFW_DRIVER_DIR}/Async/Rx/ARPacketParser.cpp"
    "${ASFW_DRIVER_DIR}/Async/Rx/PacketRouter.cpp"
    "${ASFW_TESTS_DIR}/LoggingStubs.cpp"
)

target_include_directories(asfw_packet_serdes
    PUBLIC
        "${ASFW_ROOT_DIR}"
        "${ASFW_DRIVER_DIR}"
        "${ASFW_DRIVER_DIR}/Async"
        "${ASFW_ROOT_DIR}/AppleHeaders"
        "${ASFW_TESTS_DIR}/mocks"
)

target_compile_features(asfw_packet_serdes PUBLIC cxx_std_23)
target_compile_definitions(asfw_packet_serdes PUBLIC ASFW_HOST_TEST)

add_executable(ASFWPacketTests
    "${ASFW_TESTS_DIR}/PacketSerDesTests.cpp"
    "${ASFW_TESTS_DIR}/AsyncPacketSerDesLinuxCompatTests.cpp"
)

target_link_libraries(ASFWPacketTests
    PRIVATE
        asfw_packet_serdes
        GTest::gtest_main
)

target_compile_definitions(ASFWPacketTests
    PRIVATE
        ASFW_HOST_TEST
)

target_include_directories(ASFWPacketTests
    PRIVATE
        "${ASFW_ROOT_DIR}"
        "${ASFW_DRIVER_DIR}"
        "${ASFW_DRIVER_DIR}/Async"
        "${ASFW_ROOT_DIR}/AppleHeaders"
        "${ASFW_TESTS_DIR}/mocks"
)

# TLabel Matching Tests - Critical bug fix verification
add_executable(TLabelMatchingTests
    "${ASFW_TESTS_DIR}/TLabelMatchingTests.cpp"
)

target_link_libraries(TLabelMatchingTests
    PRIVATE
        asfw_packet_serdes
        GTest::gtest_main
)

target_compile_definitions(TLabelMatchingTests
    PRIVATE
        ASFW_HOST_TEST
)

target_include_directories(TLabelMatchingTests
    PRIVATE
        "${ASFW_ROOT_DIR}"
        "${ASFW_DRIVER_DIR}"
        "${ASFW_DRIVER_DIR}/Async"
        "${ASFW_ROOT_DIR}/AppleHeaders"
        "${ASFW_TESTS_DIR}/mocks"
)

include(GoogleTest)
gtest_discover_tests(ASFWPacketTests)
gtest_discover_tests(TLabelMatchingTests)
